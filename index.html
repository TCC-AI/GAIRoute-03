
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>昶青物流-派車GAI數據管理系統</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ===== 重新設計的 CSS 樣式 ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* 藍綠色系主題色彩 */
            --primary-blue: #0ea5e9;
            --primary-teal: #14b8a6;
            --secondary-blue: #0284c7;
            --secondary-teal: #0d9488;
            --accent-cyan: #06b6d4;
            --accent-emerald: #10b981;
            
            /* 漸層色彩 */
            --gradient-primary: linear-gradient(135deg, #0ea5e9 0%, #14b8a6 100%);
            --gradient-secondary: linear-gradient(45deg, #0284c7 0%, #0d9488 100%);
            --gradient-accent: linear-gradient(225deg, #06b6d4 0%, #10b981 100%);
            --gradient-bg: linear-gradient(135deg, #f0f9ff 0%, #f0fdfa 50%, #ecfdf5 100%);
            
            /* 中性色彩 */
            --white: #ffffff;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            
            /* 狀態色彩 */
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #06b6d4;
            
            /* 陰影效果 */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            
            /* 按鈕陰影 */
            --btn-shadow: 0 4px 14px 0 rgba(14, 165, 233, 0.25);
            --btn-shadow-hover: 0 8px 25px 0 rgba(14, 165, 233, 0.35);
            --btn-shadow-active: 0 2px 8px 0 rgba(14, 165, 233, 0.4);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gradient-bg);
            color: var(--gray-800);
            line-height: 1.6;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* 非對稱背景裝飾 */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            right: -20%;
            width: 80%;
            height: 120%;
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.08) 0%, rgba(20, 184, 166, 0.05) 100%);
            border-radius: 50%;
            z-index: -2;
            animation: float 20s ease-in-out infinite;
        }

        body::after {
            content: '';
            position: fixed;
            bottom: -30%;
            left: -15%;
            width: 60%;
            height: 80%;
            background: linear-gradient(45deg, rgba(6, 182, 212, 0.06) 0%, rgba(16, 185, 129, 0.08) 100%);
            border-radius: 50%;
            z-index: -1;
            animation: float 25s ease-in-out infinite reverse;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }

        /* 登入頁面樣式 */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
            position: relative;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            box-shadow: var(--shadow-2xl);
            padding: 3rem;
            width: 100%;
            max-width: 420px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .login-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .login-header {
            margin-bottom: 2.5rem;
        }

        .login-header i {
            font-size: 3.5rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1.5rem;
            display: block;
        }

        .login-header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 0.5rem;
            letter-spacing: -0.025em;
        }

        .login-header p {
            color: var(--gray-500);
            font-size: 0.95rem;
            font-weight: 400;
        }

        .login-form {
            text-align: left;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 500;
            color: var(--gray-700);
            font-size: 0.9rem;
        }

        .form-input {
            width: 100%;
            padding: 1rem 1.25rem;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 400;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--white);
            color: var(--gray-800);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1);
            transform: translateY(-1px);
        }

        .login-btn {
            width: 100%;
            padding: 1rem 1.5rem;
            background: var(--gradient-primary);
            color: var(--white);
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--btn-shadow);
            position: relative;
            overflow: hidden;
        }

        .login-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--btn-shadow-hover);
        }

        .login-btn:hover::before {
            left: 100%;
        }

        .login-btn:active {
            transform: translateY(0);
            box-shadow: var(--btn-shadow-active);
        }

        .login-btn:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* 主系統樣式 */
        .main-system {
            display: none;
        }

        .main-system.show {
            display: block;
        }

        /* 導航列 */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-lg);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 80px;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .nav-brand i {
            font-size: 2rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-brand h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-800);
            letter-spacing: -0.025em;
        }

        .nav-user {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            font-size: 0.9rem;
        }

        .user-name {
            font-weight: 600;
            color: var(--gray-800);
        }

        .user-role {
            color: var(--gray-500);
            font-size: 0.8rem;
        }

        /* 側邊選單 */
        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            width: 280px;
            height: calc(100vh - 80px);
            position: fixed;
            top: 80px;
            left: 0;
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            padding: 2rem 0;
            overflow-y: auto;
            z-index: 999;
            box-shadow: var(--shadow-lg);
        }

        .menu-list {
            list-style: none;
            padding: 0 1rem;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 12px;
            margin-bottom: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .menu-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--gradient-primary);
            transform: scaleY(0);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .menu-item:hover {
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.08) 0%, rgba(20, 184, 166, 0.05) 100%);
            transform: translateX(4px);
        }

        .menu-item.active {
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.15) 0%, rgba(20, 184, 166, 0.1) 100%);
            color: var(--primary-blue);
            font-weight: 600;
        }

        .menu-item.active::before {
            transform: scaleY(1);
        }

        .menu-item i {
            width: 24px;
            text-align: center;
            font-size: 1.1rem;
        }

        /* 主要內容區 */
        .main-content {
            margin-left: 280px;
            margin-top: 80px;
            padding: 2.5rem;
            min-height: calc(100vh - 80px);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--gray-100);
        }

        .page-header h2 {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 2rem;
            font-weight: 700;
            color: var(--gray-800);
            letter-spacing: -0.025em;
        }

        .page-header h2 i {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        /* 按鈕樣式 - 重點提升質感 */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.025em;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: var(--white);
            box-shadow: var(--btn-shadow);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--btn-shadow-hover);
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: var(--btn-shadow-active);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--gray-600) 0%, var(--gray-700) 100%);
            color: var(--white);
            box-shadow: 0 4px 14px 0 rgba(100, 116, 139, 0.25);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px 0 rgba(100, 116, 139, 0.35);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
            color: var(--white);
            box-shadow: 0 4px 14px 0 rgba(16, 185, 129, 0.25);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px 0 rgba(16, 185, 129, 0.35);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #d97706 100%);
            color: var(--white);
            box-shadow: 0 4px 14px 0 rgba(245, 158, 11, 0.25);
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px 0 rgba(245, 158, 11, 0.35);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%);
            color: var(--white);
            box-shadow: 0 4px 14px 0 rgba(239, 68, 68, 0.25);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px 0 rgba(239, 68, 68, 0.35);
        }

        .btn-info {
            background: var(--gradient-accent);
            color: var(--white);
            box-shadow: 0 4px 14px 0 rgba(6, 182, 212, 0.25);
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px 0 rgba(6, 182, 212, 0.35);
        }

        .btn-logout {
            background: rgba(255, 255, 255, 0.8);
            color: var(--gray-600);
            border: 2px solid var(--gray-200);
            box-shadow: var(--shadow);
        }

        .btn-logout:hover {
            background: var(--white);
            border-color: var(--gray-300);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-large {
            padding: 1rem 2rem;
            font-size: 1rem;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }

        /* 卡片樣式 */
        .card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 2rem;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .card-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--gray-100);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.02) 0%, rgba(20, 184, 166, 0.01) 100%);
        }

        .card-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-800);
        }

        .card-body {
            padding: 2rem;
        }

        /* 儀表板網格 */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-bottom: 2.5rem;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            line-height: 1.2;
        }

        .stat-number.alert {
            background: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            color: var(--gray-500);
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* 天氣資訊卡片 */
        .weather-card {
            background: var(--gradient-primary);
            color: var(--white);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-xl);
            position: relative;
            overflow: hidden;
        }

        .weather-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: weatherFloat 15s ease-in-out infinite;
        }

        @keyframes weatherFloat {
            0%, 100% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(-10px) scale(1.05); }
        }

        .weather-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }

        .weather-temp {
            font-size: 3rem;
            font-weight: 700;
            line-height: 1;
        }

        .weather-icon {
            font-size: 2.5rem;
            opacity: 0.9;
        }

        .weather-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            font-size: 0.9rem;
            position: relative;
            z-index: 1;
        }

        .weather-detail {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            opacity: 0.9;
        }

        /* 地圖儀表板 */
        .maps-dashboard {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
            height: 600px;
            margin-bottom: 2rem;
        }

        .map-main-container {
            position: relative;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .map-controls {
            position: absolute;
            top: 1rem;
            left: 1rem;
            z-index: 1000;
            display: flex;
            gap: 0.5rem;
        }

        .map-control-btn {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: none;
            padding: 0.75rem;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--gray-600);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .map-control-btn:hover {
            background: var(--white);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            color: var(--primary-blue);
        }

        .map-control-btn.active {
            background: var(--gradient-primary);
            color: var(--white);
            box-shadow: var(--btn-shadow);
        }

        .maps-sidebar {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid var(--gray-100);
            background: rgba(14, 165, 233, 0.02);
        }

        .sidebar-tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--gray-600);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .sidebar-tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            transform: scaleX(0);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-tab.active {
            background: var(--white);
            color: var(--primary-blue);
            font-weight: 600;
        }

        .sidebar-tab.active::after {
            transform: scaleX(1);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        /* 表格樣式 */
        .table-container {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 1rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-100);
        }

        .data-table th {
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.05) 0%, rgba(20, 184, 166, 0.03) 100%);
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.9rem;
            letter-spacing: 0.025em;
        }

        .data-table tbody tr {
            transition: all 0.2s ease;
        }

        .data-table tbody tr:hover {
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.03) 0%, rgba(20, 184, 166, 0.02) 100%);
        }

        /* 狀態標籤 */
        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.025em;
        }

                .status-badge.啟用 {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.1) 100%);
            color: var(--success-color);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .status-badge.停用 {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(220, 38, 38, 0.1) 100%);
            color: var(--danger-color);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        /* 進度條 */
        .progress-container {
            margin: 1.5rem 0;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: var(--gray-200);
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            transition: width 0.3s ease;
            width: 0%;
            border-radius: 20px;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: progressShimmer 2s infinite;
        }

        @keyframes progressShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-text {
            text-align: center;
            margin-top: 0.75rem;
            color: var(--gray-600);
            font-weight: 500;
        }

        /* 篩選區域 */
        .filter-section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .filter-group {
            display: flex;
            gap: 1.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group .form-input,
        .filter-group .form-select {
            flex: 1;
            margin-bottom: 0;
            min-width: 200px;
        }

        .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            font-size: 0.9rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--white);
            color: var(--gray-800);
            cursor: pointer;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1);
        }

        /* 快速操作區 */
        .quick-actions {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .quick-actions h3 {
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-800);
        }

        .action-buttons {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        /* 載入遮罩 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(8px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-spinner {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 3rem;
            border-radius: 20px;
            text-align: center;
            box-shadow: var(--shadow-2xl);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .loading-spinner i {
            font-size: 3rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1.5rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-spinner p {
            color: var(--gray-600);
            font-weight: 500;
            font-size: 1.1rem;
        }

        /* 模態視窗 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(8px);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: var(--shadow-2xl);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: 2rem 2rem 1rem;
            border-bottom: 1px solid var(--gray-100);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--gray-800);
        }

        .modal-close {
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-400);
            transition: all 0.2s ease;
            padding: 0.5rem;
            border-radius: 8px;
        }

        .modal-close:hover {
            color: var(--gray-600);
            background: var(--gray-100);
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-footer {
            padding: 1rem 2rem 2rem;
            border-top: 1px solid var(--gray-100);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* 通知樣式 */
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 1.25rem 1.75rem;
            border-radius: 16px;
            color: var(--white);
            font-weight: 500;
            z-index: 9999;
            transform: translateX(100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-xl);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
        }

        .notification.error {
            background: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%);
        }

        .notification.warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #d97706 100%);
        }

        .notification.info {
            background: var(--gradient-accent);
        }

        /* 連線狀態指示器 */
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 0.75rem 1.25rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .connection-status.online {
            background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
            color: var(--white);
        }

        .connection-status.offline {
            background: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%);
            color: var(--white);
        }

        .connection-status.mock {
            background: linear-gradient(135deg, var(--warning-color) 0%, #d97706 100%);
            color: var(--white);
        }

        /* 權限不足提示 */
        .access-denied {
            text-align: center;
            padding: 4rem;
            color: var(--gray-500);
        }

        .access-denied i {
            font-size: 4rem;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, var(--warning-color) 0%, #d97706 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .access-denied h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--gray-700);
        }

        /* 優化容器 */
        .optimization-container {
            display: grid;
            gap: 2rem;
        }

        @media (min-width: 768px) {
            .optimization-container {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* 派車收送點清單表格 */
        #deliveryPointsTableContainer {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 12px;
        }

        #deliveryPointsTableContainer::-webkit-scrollbar {
            width: 8px;
        }

        #deliveryPointsTableContainer::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 4px;
        }

        #deliveryPointsTableContainer::-webkit-scrollbar-thumb {
            background: var(--gradient-primary);
            border-radius: 4px;
        }

        /* GAI預排路線區塊 */
        #gai-route-section {
            margin-top: 2rem;
            border: 2px solid transparent;
            background: linear-gradient(var(--white), var(--white)) padding-box,
                        var(--gradient-primary) border-box;
            border-radius: 20px;
            padding: 2rem;
            position: relative;
            overflow: hidden;
        }

        #gai-route-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.02) 0%, rgba(20, 184, 166, 0.01) 100%);
            z-index: -1;
        }

        #gai-route-section h3 {
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        #ai-preplan-btn {
            background: var(--gradient-primary);
            color: var(--white);
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            box-shadow: var(--btn-shadow);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        #ai-preplan-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        #ai-preplan-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--btn-shadow-hover);
        }

        #ai-preplan-btn:hover::before {
            left: 100%;
        }

        #gai-route-result {
            margin-top: 2rem;
        }

        /* 響應式設計 */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .maps-dashboard {
                grid-template-columns: 1fr;
                grid-template-rows: 400px 1fr;
                height: auto;
            }
            
            .maps-sidebar {
                max-height: 400px;
            }
        }

        @media (max-width: 768px) {
            .navbar {
                padding: 1rem;
            }

            .nav-brand h1 {
                font-size: 1.2rem;
            }

            .login-card {
                padding: 2rem;
                margin: 1rem;
            }

            .main-content {
                padding: 1.5rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .filter-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group .form-input,
            .filter-group .form-select {
                min-width: auto;
            }
            
            .action-buttons {
                flex-direction: column;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .header-actions {
                width: 100%;
                justify-content: flex-start;
            }

            .btn {
                padding: 0.75rem 1.25rem;
                font-size: 0.85rem;
            }

            .notification {
                right: 10px;
                left: 10px;
                min-width: auto;
                transform: translateY(-100%);
            }

            .notification.show {
                transform: translateY(0);
            }
        }

        @media (max-width: 480px) {
            .login-card {
                padding: 1.5rem;
            }

            .main-content {
                padding: 1rem;
            }

            .card-body {
                padding: 1.5rem;
            }

            .modal-content {
                margin: 1rem;
                max-width: calc(100vw - 2rem);
            }

            .modal-header,
            .modal-body,
            .modal-footer {
                padding: 1.5rem;
            }

            .weather-card {
                padding: 1.5rem;
            }

            .weather-temp {
                font-size: 2.5rem;
            }

            .weather-icon {
                font-size: 2rem;
            }
        }

        /* 自定義滾動條 */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gradient-primary);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--gradient-secondary);
        }

        /* 選取文字樣式 */
        ::selection {
            background: rgba(14, 165, 233, 0.2);
            color: var(--gray-800);
        }

        ::-moz-selection {
            background: rgba(14, 165, 233, 0.2);
            color: var(--gray-800);
        }

        /* 焦點樣式 */
        *:focus-visible {
            outline: 2px solid var(--primary-blue);
            outline-offset: 2px;
        }

        /* 動畫優化 */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* 高對比度模式支援 */
        @media (prefers-contrast: high) {
            :root {
                --shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.3);
                --shadow-md: 0 4px 8px 0 rgba(0, 0, 0, 0.3);
                --shadow-lg: 0 8px 16px 0 rgba(0, 0, 0, 0.3);
            }
            
            .btn {
                border: 2px solid currentColor;
            }
        }

        /* 深色模式準備 */
        @media (prefers-color-scheme: dark) {
            /* 可以在這裡添加深色模式樣式 */
        }

        /* 列印樣式 */
        @media print {
            .sidebar,
            .navbar,
            .btn,
            .modal,
            .notification,
            .connection-status {
                display: none !important;
            }
            
            .main-content {
                margin: 0;
                padding: 0;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid var(--gray-300);
            }
        }
    </style>
</head>
<body>
    <!-- 登入頁面 -->
    <div id="loginContainer" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <i class="fas fa-truck"></i>
                <h1>昶青物流</h1>
                <p>派車GAI數據管理系統</p>
            </div>
            <form class="login-form" id="loginForm">
                <div class="form-group">
                    <label for="username">帳號</label>
                    <input type="text" id="username" class="form-input" placeholder="請輸入帳號" required>
                </div>
                <div class="form-group">
                    <label for="password">密碼</label>
                    <input type="password" id="password" class="form-input" placeholder="請輸入密碼" required>
                </div>
                <button type="submit" class="login-btn" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> 登入
                </button>
                <div id="loginError" class="login-error"></div>
            </form>
        </div>
    </div>

    <!-- 主系統 -->
    <div id="mainSystem" class="main-system">
        <!-- 頂部導航 -->
        <nav class="navbar">
            <div class="nav-brand">
                <i class="fas fa-truck"></i>
                <h1>昶青物流-派車GAI數據管理系統</h1>
            </div>
            <div class="nav-user">
                <div class="user-info">
                    <span class="user-name" id="currentUserName">使用者</span>
                    <span class="user-role" id="currentUserRole">角色</span>
                </div>
                <button id="logoutBtn" class="btn btn-logout">
                    <i class="fas fa-sign-out-alt"></i> 登出
                </button>
            </div>
        </nav>

        <!-- 側邊選單 -->
        <aside class="sidebar" id="sidebar">
            <ul class="menu-list">
                <li class="menu-item active" data-page="dashboard" data-permission="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>主控台</span>
                </li>
                <li class="menu-item" data-page="route-management" data-permission="route-management">
                    <i class="fas fa-route"></i>
                    <span>路線管理</span>
                </li>
                <li class="menu-item" data-page="route-optimization" data-permission="route-optimization">
                    <i class="fas fa-brain"></i>
                    <span>AI路線優化</span>
                </li>
                <li class="menu-item" data-page="seasonal-routes" data-permission="seasonal-routes">
                    <i class="fas fa-calendar-alt"></i>
                    <span>季節性路線</span>
                </li>
                <li class="menu-item" data-page="cargo-vehicle" data-permission="cargo-vehicle">
                    <i class="fas fa-boxes"></i>
                    <span>載運管理</span>
                </li>
                <li class="menu-item" data-page="real-time-monitor" data-permission="real-time-monitor">
                    <i class="fas fa-satellite-dish"></i>
                    <span>即時監控</span>
                </li>
                <li class="menu-item" data-page="system-settings" data-permission="system-settings">
                    <i class="fas fa-cog"></i>
                    <span>系統設定</span>
                </li>
                <li class="menu-item" data-page="reports" data-permission="reports">
                    <i class="fas fa-chart-bar"></i>
                    <span>報表分析</span>
                </li>
            </ul>
        </aside>

        <!-- 主要內容區 -->
        <main class="main-content" id="mainContent">
            <!-- 主控台頁面 -->
            <div id="dashboard" class="page active">
                <div class="page-header">
                    <h2><i class="fas fa-tachometer-alt"></i> 主控台</h2>
                    <div class="header-actions">
                        <button class="btn btn-primary" id="refreshDashboard">
                            <i class="fas fa-sync-alt"></i> 重新整理
                        </button>
                        <button class="btn btn-info" id="toggleMapView">
                            <i class="fas fa-map"></i> 地圖模式
                        </button>
                    </div>
                </div>

                <!-- 天氣資訊卡片 -->
                <div class="weather-card" id="weatherCard">
                    <div class="weather-header">
                        <div>
                            <div class="weather-temp" id="weatherTemp">--°C</div>
                            <div id="weatherDescription">載入中...</div>
                        </div>
                        <div class="weather-icon" id="weatherIcon">
                            <i class="fas fa-cloud"></i>
                        </div>
                    </div>
                    <div class="weather-details">
                        <div class="weather-detail">
                            <i class="fas fa-eye"></i>
                            <span id="weatherVisibility">-- km</span>
                        </div>
                        <div class="weather-detail">
                            <i class="fas fa-wind"></i>
                            <span id="weatherWind">-- km/h</span>
                        </div>
                        <div class="weather-detail">
                            <i class="fas fa-tint"></i>
                            <span id="weatherHumidity">--%</span>
                        </div>
                        <div class="weather-detail">
                            <i class="fas fa-thermometer-half"></i>
                            <span id="weatherFeelsLike">--°C</span>
                        </div>
                    </div>
                </div>
                
                <!-- 地圖儀表板 -->
                <div class="maps-dashboard" id="mapsDashboard" style="display: none;">
                    <div class="map-main-container">
                        <div class="map-controls">
                            <button class="map-control-btn" id="toggleTraffic" title="交通狀況">
                                <i class="fas fa-traffic-light"></i>
                            </button>
                            <button class="map-control-btn" id="toggleTransit" title="大眾運輸">
                                <i class="fas fa-bus"></i>
                            </button>
                            <button class="map-control-btn" id="toggleBicycling" title="自行車道">
                                <i class="fas fa-bicycle"></i>
                            </button>
                            <button class="map-control-btn" id="centerMap" title="回到中心">
                                <i class="fas fa-crosshairs"></i>
                            </button>
                        </div>
                        <div id="googleMap" style="width: 100%; height: 100%;"></div>
                        <div class="map-loading-overlay" id="mapLoadingOverlay" style="display: none;">
                            <div class="map-loading-spinner"></div>
                        </div>
                    </div>
                    
                    <div class="maps-sidebar">
                        <div class="sidebar-tabs">
                            <button class="sidebar-tab active" data-tab="search">搜尋</button>
                            <button class="sidebar-tab" data-tab="routes">路線</button>
                            <button class="sidebar-tab" data-tab="optimize">優化</button>
                        </div>
                        
                        <div class="sidebar-content">
                            <!-- 搜尋標籤 -->
                            <div id="search-tab" class="tab-content">
                                <div class="places-search">
                                    <input type="text" id="placesSearch" class="form-input" placeholder="搜尋地點...">
                                    <div id="placesSuggestions" class="places-suggestions" style="display: none;"></div>
                                </div>
                                
                                <div class="route-planner">
                                    <h4>路線規劃</h4>
                                    <div id="waypointsList">
                                        <div class="waypoint-input">
                                            <i class="fas fa-circle" style="color: green;"></i>
                                            <input type="text" placeholder="起點" class="form-input waypoint-address" data-type="origin">
                                        </div>
                                        <div class="waypoint-input">
                                            <i class="fas fa-circle" style="color: red;"></i>
                                            <input type="text" placeholder="終點" class="form-input waypoint-address" data-type="destination">
                                        </div>
                                    </div>
                                    <div style="margin: 0.5rem 0;">
                                        <button class="btn btn-sm btn-secondary" id="addWaypoint">
                                            <i class="fas fa-plus"></i> 新增途經點
                                        </button>
                                    </div>
                                    <button class="btn btn-primary" id="calculateRoute">
                                        <i class="fas fa-route"></i> 計算路線
                                    </button>
                                </div>
                            </div>
                            
                            <!-- 路線標籤 -->
                            <div id="routes-tab" class="tab-content" style="display: none;">
                                <div id="routeInfo" class="route-info-card" style="display: none;">
                                 
                                    <div class="route-stats">
                                        <div class="stat-item">
                                            <div class="stat-value" id="routeDistance">--</div>
                                            <div class="stat-label">距離</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-value" id="routeDuration">--</div>
                                            <div class="stat-label">時間</div>
                                        </div>
                                    </div>
                                    <button class="btn btn-success btn-sm" id="saveRoute">
                                        <i class="fas fa-save"></i> 儲存路線
                                    </button>
                                </div>
                                
                                <div>
                                    <h4>距離矩陣</h4>
                                    <button class="btn btn-info btn-sm" id="calculateMatrix">
                                        <i class="fas fa-calculator"></i> 計算矩陣
                                    </button>
                                    <div id="distanceMatrix" class="distance-matrix"></div>
                                </div>
                            </div>
                            
                            <!-- 優化標籤 -->
                            <div id="optimize-tab" class="tab-content" style="display: none;">
                                <div class="optimization-panel">
                                    <h4>路線優化</h4>
                                    <div class="optimization-options">
                                        <label class="opt-radio">
                                            <input type="radio" name="optType" value="distance" checked>
                                            最短距離
                                        </label>
                                        <label class="opt-radio">
                                            <input type="radio" name="optType" value="time">
                                            最短時間
                                        </label>
                                        <label class="opt-radio">
                                            <input type="radio" name="optType" value="traffic">
                                            避開壅塞
                                        </label>
                                    </div>
                                    <button class="btn btn-warning btn-sm" id="optimizeRoute">
                                        <i class="fas fa-magic"></i> 優化路線
                                    </button>
                                </div>
                                
                                <div id="optimizationResults" style="display: none;">
                                    <h4>優化結果</h4>
                                    <div class="result-summary">
                                        <div class="result-item">
                                            <span>節省距離：</span>
                                            <span class="result-value improvement" id="savedDistance">--</span>
                                        </div>
                                        <div class="result-item">
                                            <span>節省時間：</span>
                                            <span class="result-value improvement" id="savedTime">--</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 即時監控面板 -->
                <div class="dashboard-grid" id="dashboardStats">
                    <div class="card">
                        <div class="card-header">
                            <h3>今日配送狀況</h3>
                            <i class="fas fa-shipping-fast"></i>
                        </div>
                        <div class="card-body">
                            <div class="stat-number" id="todayDeliveries">0</div>
                            <div class="stat-label">已完成配送</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3>車輛使用率</h3>
                            <i class="fas fa-truck"></i>
                        </div>
                        <div class="card-body">
                            <div class="stat-number" id="vehicleUsage">0%</div>
                            <div class="stat-label">使用中車輛</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3>準時率</h3>
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="card-body">
                            <div class="stat-number" id="onTimeRate">0%</div>
                            <div class="stat-label">準時配送率</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3>異常警示</h3>
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="card-body">
                            <div class="stat-number alert" id="alertCount">0</div>
                            <div class="stat-label">待處理異常</div>
                        </div>
                    </div>
                </div>

                <!-- 快速操作區 -->
                <div class="quick-actions">
                    <h3>快速操作</h3>
                    <div class="action-buttons">
                        <button class="btn btn-danger" id="emergencyDispatch">
                            <i class="fas fa-ambulance"></i> 緊急調派
                        </button>
                        <button class="btn btn-warning" id="rerouteAll">
                            <i class="fas fa-route"></i> 路線重規劃
                        </button>
                        <button class="btn btn-info" id="realTimeReroute">
                            <i class="fas fa-directions"></i> 即時改道
                        </button>
                    </div>
                </div>
            </div>

            <!-- 路線管理頁面 -->
            <div id="route-management" class="page">
                <div class="page-header">
                    <h2><i class="fas fa-route"></i> 路線管理</h2>
                    <div class="header-actions">
                        <button class="btn btn-primary" id="addRoute">
                            <i class="fas fa-plus"></i> 新增路線
                        </button>
                        <button class="btn btn-secondary" id="importRoutes">
                            <i class="fas fa-upload"></i> 批量匯入
                        </button>
                        <button class="btn btn-info" id="toggleRouteMapView">
                            <i class="fas fa-map"></i> 地圖模式
                        </button>
                    </div>
                </div>

                <!-- 搜尋與篩選 -->
                <div class="filter-section">
                    <div class="filter-group">
                        <input type="text" id="routeSearch" placeholder="搜尋路線..." class="form-input">
                        <select id="regionFilter" class="form-select">
                            <option value="">全部區域</option>
                            <option value="north">北部</option>
                            <option value="central">中部</option>
                            <option value="south">南部</option>
                            <option value="east">東部</option>
                        </select>
                        <button class="btn btn-primary" id="searchRoutes">
                            <i class="fas fa-search"></i> 搜尋
                        </button>
                    </div>
                </div>

                <!-- 路線地圖容器 -->
                <div class="maps-dashboard" id="routeMapsDashboard" style="display: none;">
                    <div class="map-main-container">
                        <div id="routeGoogleMap" style="width: 100%; height: 100%;"></div>
                    </div>
                    <div class="maps-sidebar">
                        <div class="sidebar-content">
                            <h4>路線列表</h4>
                            <div id="routeMapList"></div>
                        </div>
                    </div>
                </div>

                <!-- 路線表格容器 -->
                <div class="table-container" id="routeTableContainer">
                    <table class="data-table" id="routeTable">
                        <thead>
                            <tr>
                                <th>路線編號</th>
                                <th>路線名稱</th>
                                <th>起點</th>
                                <th>終點</th>
                                <th>收送點數量</th>
                                <th>預估時間</th>
                                <th>狀態</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="routeTableBody">
                            <!-- 動態載入資料 -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- AI路線優化頁面 -->
            <div id="route-optimization" class="page">
                <div class="page-header">
                    <h2><i class="fas fa-brain"></i> AI路線優化</h2>
                </div>
                
                <!-- 派車收送點清單區塊 -->
                <div id="deliveryPointsPanel" class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-header" style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <h3 style="margin: 0;">派車收送點清單</h3>
                        </div>
                        <div>
                            <input type="date" id="deliveryDatePicker" class="form-input" style="width: auto;">
                            <button class="btn btn-primary btn-sm" id="fetchDeliveryPointsBtn">
                                <i class="fas fa-search"></i> 查詢
                            </button>
                        </div>
                    </div>
                    <div class="card-body" style="padding: 1rem;">
                        <div id="deliveryPointsTableContainer">
                            <!-- 資料表格將由 JS 動態產生 -->
                        </div>
                        <button id="toggleDeliveryPoints" class="btn btn-secondary btn-sm" style="margin-top: 0.5rem; display: none;">
                            展開更多
                        </button>
                    </div>
                </div>
                
                <!-- GAI預排路線區塊 -->
                <div id="gai-route-section" style="margin-top:2em; border:1px solid #e2e8f0; border-radius:8px; padding:1em; background:#fff;">
                    <h3 style="margin-bottom:1em;">GAI預排路線</h3>
                    <button id="ai-preplan-btn" style="background:#2563eb; color:#fff; border:none; padding:0.5em 1.5em; border-radius:4px; cursor:pointer;">
                        <i class="fa-solid fa-robot"></i> AI預排
                    </button>
                    <div id="gai-route-result" style="margin-top:1.5em;"></div>
                </div>

                <div class="optimization-container">
                    <!-- 優化參數設定 -->
                    <div class="card">
                        <div class="card-header">
                            <h3>優化參數設定</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label>優化目標：</label>
                                <div class="radio-group">
                                    <label><input type="radio" name="optimizeTarget" value="time" checked> 最短時間</label>
                                    <label><input type="radio" name="optimizeTarget" value="distance"> 最短距離</label>
                                    <label><input type="radio" name="optimizeTarget" value="cost"> 最低成本</label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>車輛限制：</label>
                                <input type="number" id="vehicleLimit" class="form-input" placeholder="最大車輛數">
                            </div>
                            
                            <div class="form-group">
                                <label>時間窗口：</label>
                                <input type="time" id="startTime" class="form-input">
                                <span>至</span>
                                <input type="time" id="endTime" class="form-input">
                            </div>
                            
                            <button class="btn btn-primary btn-large" id="startOptimization">
                                <i class="fas fa-play"></i> 開始優化分析
                            </button>
                        </div>
                    </div>

                    <!-- 優化結果 -->
                    <div class="card">
                        <div class="card-header">
                            <h3>優化結果</h3>
                        </div>
                        <div class="card-body">
                            <div id="optimizationProgress" class="progress-container" style="display: none;">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progressFill"></div>
                                </div>
                                <div class="progress-text" id="progressText">分析中...</div>
                            </div>
                            
                            <div id="optimizationResults" style="display: none;">
                                <div class="result-summary">
                                    <div class="result-item">
                                        <span class="result-label">優化前總距離：</span>
                                        <span class="result-value" id="beforeDistance">-</span>
                                    </div>
                                    <div class="result-item">
                                        <span class="result-label">優化後總距離：</span>
                                        <span class="result-value" id="afterDistance">-</span>
                                    </div>
                                    <div class="result-item">
                                        <span class="result-label">節省距離：</span>
                                        <span class="result-value improvement" id="savedDistance">-</span>
                                    </div>
                                </div>
                                
                                <div class="action-buttons">
                                    <button class="btn btn-success" id="applyOptimization">
                                        <i class="fas fa-check"></i> 採用建議
                                    </button>
                                    <button class="btn btn-secondary" id="exportResults">
                                        <i class="fas fa-download"></i> 匯出報告
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 季節性路線頁面 -->
            <div id="seasonal-routes" class="page">
                <div class="page-header">
                    <h2><i class="fas fa-calendar-alt"></i> 季節性路線</h2>
                    <div class="header-actions">
                        <button class="btn btn-primary" id="addSeasonalRoute">
                            <i class="fas fa-plus"></i> 新增季節路線
                        </button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <p>季節性路線管理功能開發中...</p>
                    </div>
                </div>
            </div>

            <!-- 載運管理頁面 -->
            <div id="cargo-vehicle" class="page">
                <div class="page-header">
                    <h2><i class="fas fa-boxes"></i> 載運管理</h2>
                    <div class="header-actions">
                        <button class="btn btn-primary" id="addVehicle">
                            <i class="fas fa-plus"></i> 新增車輛
                        </button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <p>載運管理功能開發中...</p>
                    </div>
                </div>
            </div>

            <!-- 即時監控頁面 -->
            <div id="real-time-monitor" class="page">
                <div class="page-header">
                    <h2><i class="fas fa-satellite-dish"></i> 即時監控</h2>
                    <div class="header-actions">
                        <button class="btn btn-primary" id="refreshMonitor">
                            <i class="fas fa-sync-alt"></i> 重新整理
                        </button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <p>即時監控功能開發中...</p>
                    </div>
                </div>
            </div>

            <!-- 系統設定頁面 -->
            <div id="system-settings" class="page">
                <div class="page-header">
                    <h2><i class="fas fa-cog"></i> 系統設定</h2>
                </div>
                <div id="accessDenied" class="access-denied" style="display: none;">
                    <i class="fas fa-lock"></i>
                    <h3>存取被拒絕</h3>
                    <p>您沒有權限存取此頁面</p>
                </div>
                <div class="card" id="settingsContent">
                    <div class="card-body">
                        <p>系統設定功能開發中...</p>
                    </div>
                </div>
            </div>

            <!-- 報表分析頁面 -->
            <div id="reports" class="page">
                <div class="page-header">
                    <h2><i class="fas fa-chart-bar"></i> 報表分析</h2>
                    <div class="header-actions">
                        <button class="btn btn-primary" id="generateReport">
                            <i class="fas fa-file-alt"></i> 生成報表
                        </button>
                    </div>
                </div>
                <div id="reportsAccessDenied" class="access-denied" style="display: none;">
                    <i class="fas fa-lock"></i>
                    <h3>存取被拒絕</h3>
                    <p>您沒有權限存取此頁面</p>
                </div>
                <div class="card" id="reportsContent">
                    <div class="card-body">
                        <p>報表分析功能開發中...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 載入中遮罩 -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>載入中...</p>
        </div>
    </div>

    <!-- 模態視窗 -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">標題</h3>
                <span class="modal-close" id="modalClose">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- 動態內容 -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="modalCancel">取消</button>
                <button class="btn btn-primary" id="modalConfirm">確認</button>
            </div>
        </div>
    </div>

    <!-- 通知容器 -->
    <div id="notificationContainer"></div>

    <!-- 連線狀態指示器 -->
    <div id="connectionStatus" class="connection-status online">
        <i class="fas fa-wifi"></i> 已連線
    </div>

    <script>
        // ==================== Google Maps API 動態載入 ====================
        let mapsApiLoaded = false;
        let mapsApiLoading = false;

        function loadGoogleMapsAPI() {
            return new Promise((resolve, reject) => {
                // 檢查是否已載入
                if (window.google && window.google.maps) {
                    mapsApiLoaded = true;
                    resolve();
                    return;
                }
                
                // 檢查是否正在載入
                if (mapsApiLoading) {
                    // 等待載入完成
                    const checkLoaded = setInterval(() => {
                        if (mapsApiLoaded) {
                            clearInterval(checkLoaded);
                            resolve();
                        }
                    }, 100);
                    return;
                }
                
                mapsApiLoading = true;
                
                // 創建 script 標籤
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyDtP8oDCXfr0CPLyVv_WrAqmk2V9QgteLI&libraries=places,geometry&region=TW&language=zh-TW`;
                script.async = true;
                script.defer = true;
                
                // 設置全局回調函數
                window.initGoogleMaps = function() {
                    mapsApiLoaded = true;
                    mapsApiLoading = false;
                    console.log('Google Maps API 載入完成');
                    resolve();
                };
                
                script.src += '&callback=initGoogleMaps';
                
                script.onerror = function() {
                    mapsApiLoading = false;
                    console.error('Google Maps API 載入失敗');
                    reject(new Error('Google Maps API 載入失敗'));
                };
                
                document.head.appendChild(script);
            });
        }

        // ===== JavaScript 代碼 =====
        
        // 全域變數
        const CONFIG = {
            SPREADSHEET_ID: '1miCf_ZTVyzmA1MNbbZM3uUdZjluk99gZUH5w2q_XWs8',
            GAS_URL: 'https://script.google.com/macros/s/AKfycbx8r_PbzcSz-D4CJk0WNc96AEIgocgUMYQI9FlOUg7O_Mvz5wwlaLacK_nd9ZGdfLm1/exec',
            // 新增外部APPS SCRIPT配置
            EXTERNAL_SHEET_ID: '109Qjbwi08bvficzUHx0hkON7UgL08i5zXQ6BPI4KwIE',
            EXTERNAL_GAS_URL: 'https://script.google.com/macros/s/AKfycbyLMLKqaGsMoDg1RyBFujjS7vS00BAY0H71QzW753RJDxg4bW7PMhEW7jeOqEU11V6hng/exec',
            USE_MOCK_DATA: false,
            MAPS_API_KEY: 'AIzaSyDtP8oDCXfr0CPLyVv_WrAqmk2V9QgteLI',
            WEATHER_API_KEY: 'a4806bc2577c0c227f9acd8bccb566a5',
            SHEETS: {
                DASHBOARD: '主控台',
                ROUTES: '路線管理',
                OPTIMIZATION: 'AI路線優化', 
                SEASONAL: '季節性路線',
                CARGO_VEHICLE: '載運管理',
                REALTIME: '即時監控',
                SETTINGS: '系統設定',
                LOGS: '報表分析',
                USERS: '管制名單'
            }
        };

        // 權限配置
        const PERMISSIONS = {
            's4': {
                level: 4,
                name: '管理者',
                pages: ['dashboard', 'route-management', 'route-optimization', 'seasonal-routes', 'cargo-vehicle', 'real-time-monitor', 'system-settings', 'reports']
            },
            's3': {
                level: 3,
                name: '主要執行者',
                pages: ['dashboard', 'route-management', 'route-optimization', 'seasonal-routes', 'cargo-vehicle', 'real-time-monitor', 'reports']
            },
            's2': {
                level: 2,
                name: '次要執行者',
                pages: ['dashboard', 'route-management', 'route-optimization', 'seasonal-routes', 'cargo-vehicle', 'real-time-monitor']
            },
            's1': {
                level: 1,
                name: '初階使用者',
                pages: ['dashboard']
            }
        };

        // 當前使用者資訊
        let currentUser = {
            username: '',
            name: '',
            role: '',
            level: '',
            permissions: [],
            lastLogin: null
        };

        // Google Maps 整合類別
        class GoogleMapsIntegration {
            constructor() {
                this.map = null;
                this.directionsService = null;
                this.directionsRenderer = null;
                this.placesService = null;
                this.geocoder = null;
                this.distanceMatrixService = null;
                this.trafficLayer = null;
                this.transitLayer = null;
                this.bikeLayer = null;
                this.currentRoute = null;
                this.markers = [];
                this.autocompleteService = null;
                this.isInitialized = false;
            }

            // 初始化 Google Maps
            async initializeMap(containerId = 'googleMap') {
                if (!window.google || !window.google.maps) {
                    console.error('Google Maps API 尚未載入');
                    return false;
                }

                try {
                    const mapContainer = document.getElementById(containerId);
                    if (!mapContainer) {
                        console.error(`找不到地圖容器: ${containerId}`);
                        return false;
                    }

                    // 初始化地圖 (以台北為中心)
                    this.map = new google.maps.Map(mapContainer, {
                        zoom: 12,
                        center: { lat: 25.0330, lng: 121.5654 }, // 台北市
                        mapTypeControl: true,
                        streetViewControl: true,
                        fullscreenControl: true,
                        zoomControl: true,
                        styles: [
                            {
                                featureType: 'poi',
                                elementType: 'labels',
                                stylers: [{ visibility: 'on' }]
                            }
                        ]
                    });

                    // 初始化服務
                    this.directionsService = new google.maps.DirectionsService();
                    this.directionsRenderer = new google.maps.DirectionsRenderer({
                        draggable: true,
                        panel: null
                    });
                    this.directionsRenderer.setMap(this.map);

                    this.placesService = new google.maps.places.PlacesService(this.map);
                    this.geocoder = new google.maps.Geocoder();
                    this.distanceMatrixService = new google.maps.DistanceMatrixService();
                    this.autocompleteService = new google.maps.places.AutocompleteService();

                    // 初始化圖層
                    this.trafficLayer = new google.maps.TrafficLayer();
                    this.transitLayer = new google.maps.TransitLayer();
                    this.bikeLayer = new google.maps.BicyclingLayer();

                    // 設定路線拖拽事件
                    this.directionsRenderer.addListener('directions_changed', () => {
                        this.onRouteChanged();
                    });

                    this.isInitialized = true;
                    console.log('Google Maps 初始化完成');
                    return true;

                } catch (error) {
                    console.error('Google Maps 初始化失敗:', error);
                    return false;
                }
            }

            // 切換圖層顯示
            toggleLayer(layerType) {
                if (!this.isInitialized) return;

                switch (layerType) {
                    case 'traffic':
                        if (this.trafficLayer.getMap()) {
                            this.trafficLayer.setMap(null);
                            return false;
                        } else {
                            this.trafficLayer.setMap(this.map);
                            return true;
                        }
                    case 'transit':
                        if (this.transitLayer.getMap()) {
                            this.transitLayer.setMap(null);
                            return false;
                        } else {
                            this.transitLayer.setMap(this.map);
                            return true;
                        }
                    case 'bicycling':
                        if (this.bikeLayer.getMap()) {
                            this.bikeLayer.setMap(null);
                            return false;
                        } else {
                            this.bikeLayer.setMap(this.map);
                            return true;
                        }
                }
            }

            // 地點搜尋
            async searchPlaces(query, callback) {
                if (!this.autocompleteService) return;

                const request = {
                    input: query,
                    componentRestrictions: { country: 'tw' }, // 限制台灣
                    types: ['establishment', 'geocode']
                };

                this.autocompleteService.getPlacePredictions(request, (predictions, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK && predictions) {
                        callback(predictions);
                    } else {
                        callback([]);
                    }
                });
            }

            // 地理編碼 - 地址轉座標
            async geocodeAddress(address) {
                return new Promise((resolve, reject) => {
                    this.geocoder.geocode({ address: address }, (results, status) => {
                        if (status === 'OK' && results[0]) {
                            resolve({
                                location: results[0].geometry.location,
                                formatted_address: results[0].formatted_address,
                                place_id: results[0].place_id
                            });
                        } else {
                          
                            reject(new Error(`地理編碼失敗: ${status}`));
                        }
                    });
                });
            }

            // 計算路線
            async calculateRoute(waypoints, optimizeWaypoints = false) {
                if (!this.directionsService || waypoints.length < 2) return null;

                const origin = waypoints[0];
                const destination = waypoints[waypoints.length - 1];
                const waypointsArray = waypoints.slice(1, -1).map(point => ({
                    location: point,
                    stopover: true
                }));

                const request = {
                    origin: origin,
                    destination: destination,
                    waypoints: waypointsArray,
                    optimizeWaypoints: optimizeWaypoints,
                    travelMode: google.maps.TravelMode.DRIVING,
                    unitSystem: google.maps.UnitSystem.METRIC,
                    avoidHighways: false,
                    avoidTolls: false
                };

                return new Promise((resolve, reject) => {
                    this.directionsService.route(request, (result, status) => {
                        if (status === 'OK') {
                            this.directionsRenderer.setDirections(result);
                            this.currentRoute = result;
                            
                            // 計算總距離和時間
                            let totalDistance = 0;
                            let totalDuration = 0;
                            
                            result.routes[0].legs.forEach(leg => {
                                totalDistance += leg.distance.value;
                                totalDuration += leg.duration.value;
                            });

                            const routeInfo = {
                                distance: (totalDistance / 1000).toFixed(2) + ' km',
                                duration: Math.ceil(totalDuration / 60) + ' 分鐘',
                                distanceValue: totalDistance,
                                durationValue: totalDuration,
                                route: result
                            };

                            resolve(routeInfo);
                        } else {
                            reject(new Error(`路線計算失敗: ${status}`));
                        }
                    });
                });
            }

            // 計算距離矩陣
            async calculateDistanceMatrix(origins, destinations) {
                if (!this.distanceMatrixService) return null;

                return new Promise((resolve, reject) => {
                    this.distanceMatrixService.getDistanceMatrix({
                        origins: origins,
                        destinations: destinations,
                        travelMode: google.maps.TravelMode.DRIVING,
                        unitSystem: google.maps.UnitSystem.METRIC,
                        avoidHighways: false,
                        avoidTolls: false
                    }, (response, status) => {
                        if (status === 'OK') {
                            resolve(response);
                        } else {
                            reject(new Error(`距離矩陣計算失敗: ${status}`));
                        }
                    });
                });
            }

            // 新增標記
            addMarker(position, title, icon = null) {
                const marker = new google.maps.Marker({
                    position: position,
                    map: this.map,
                    title: title,
                    icon: icon
                });

                this.markers.push(marker);
                return marker;
            }

            // 清除所有標記
            clearMarkers() {
                this.markers.forEach(marker => {
                    marker.setMap(null);
                });
                this.markers = [];
            }

            // 路線變更事件處理
            onRouteChanged() {
                if (this.currentRoute) {
                    // 更新路線資訊顯示
                    this.updateRouteInfo();
                }
            }

            // 更新路線資訊顯示
            updateRouteInfo() {
                const routeInfoElement = document.getElementById('routeInfo');
                const distanceElement = document.getElementById('routeDistance');
                const durationElement = document.getElementById('routeDuration');

                if (this.currentRoute && routeInfoElement) {
                    let totalDistance = 0;
                    let totalDuration = 0;

                    this.currentRoute.routes[0].legs.forEach(leg => {
                        totalDistance += leg.distance.value;
                        totalDuration += leg.duration.value;
                    });

                    if (distanceElement) {
                        distanceElement.textContent = (totalDistance / 1000).toFixed(2) + ' km';
                    }
                    if (durationElement) {
                        durationElement.textContent = Math.ceil(totalDuration / 60) + ' 分鐘';
                    }

                    routeInfoElement.style.display = 'block';
                }
            }

            // 回到地圖中心
            centerMap() {
                if (this.map) {
                    this.map.setCenter({ lat: 25.0330, lng: 121.5654 });
                    this.map.setZoom(12);
                }
            }
        }

        // 主要應用程式類別
        class DispatchGAISystem {
            constructor() {
                this.mapsIntegration = new GoogleMapsIntegration();
                this.currentWeather = null;
                this.dashboardData = null;
                this.routeData = [];
                this.optimizationResults = null;
            }

            // 系統初始化
            async init() {
                console.log('初始化派車GAI系統...');
                
                // 初始化事件監聽器
                this.initEventListeners();
                
                // 檢查登入狀態
                this.checkLoginStatus();
                
                // 初始化權限檢查
                this.initPermissions();
                
                // 載入天氣資訊
                await this.loadWeatherData();
                
                // 載入儀表板資料
                await this.loadDashboardData();
                
                console.log('系統初始化完成');
            }

            // 初始化事件監聽器
            initEventListeners() {
                // 登入表單
                document.getElementById('loginForm')?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleLogin();
                });

                // 登出按鈕
                document.getElementById('logoutBtn')?.addEventListener('click', () => {
                    this.handleLogout();
                });

                // 側邊選單項目
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const page = e.currentTarget.dataset.page;
                        const permission = e.currentTarget.dataset.permission;
                        this.navigateToPage(page, permission);
                    });
                });

                // 地圖控制按鈕
                document.getElementById('toggleMapView')?.addEventListener('click', () => {
                    this.toggleMapView();
                });

                document.getElementById('toggleRouteMapView')?.addEventListener('click', () => {
                    this.toggleRouteMapView();
                });

                // 地圖圖層控制
                document.getElementById('toggleTraffic')?.addEventListener('click', (e) => {
                    const isActive = this.mapsIntegration.toggleLayer('traffic');
                    e.target.classList.toggle('active', isActive);
                });

                document.getElementById('toggleTransit')?.addEventListener('click', (e) => {
                    const isActive = this.mapsIntegration.toggleLayer('transit');
                    e.target.classList.toggle('active', isActive);
                });

                document.getElementById('toggleBicycling')?.addEventListener('click', (e) => {
                    const isActive = this.mapsIntegration.toggleLayer('bicycling');
                    e.target.classList.toggle('active', isActive);
                });

                document.getElementById('centerMap')?.addEventListener('click', () => {
                    this.mapsIntegration.centerMap();
                });

                // 地點搜尋
                document.getElementById('placesSearch')?.addEventListener('input', (e) => {
                    this.handlePlacesSearch(e.target.value);
                });

                // 路線計算
                document.getElementById('calculateRoute')?.addEventListener('click', () => {
                    this.calculateRoute();
                });

                // 新增途經點
                document.getElementById('addWaypoint')?.addEventListener('click', () => {
                    this.addWaypoint();
                });

                // 儲存路線
                document.getElementById('saveRoute')?.addEventListener('click', () => {
                    this.saveRoute();
                });

                // 計算距離矩陣
                document.getElementById('calculateMatrix')?.addEventListener('click', () => {
                    this.calculateDistanceMatrix();
                });

                // 路線優化
                document.getElementById('optimizeRoute')?.addEventListener('click', () => {
                    this.optimizeRoute();
                });

                // 側邊標籤切換
                document.querySelectorAll('.sidebar-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        this.switchSidebarTab(e.target.dataset.tab);
                    });
                });

                // 儀表板重新整理
                document.getElementById('refreshDashboard')?.addEventListener('click', () => {
                    this.refreshDashboard();
                });

                // 派車收送點查詢按鈕
                document.getElementById('fetchDeliveryPointsBtn')?.addEventListener('click', async () => {
                    await this.fetchDeliveryPoints();
                });

                // AI預排按鈕
                document.getElementById('ai-preplan-btn')?.addEventListener('click', async () => {
                    await this.handleAIPreplan();
                });

                // 優化分析按鈕
                document.getElementById('startOptimization')?.addEventListener('click', () => {
                    this.startOptimizationAnalysis();
                });

                // 模態視窗控制
                document.getElementById('modalClose')?.addEventListener('click', () => {
                    this.hideModal();
                });

                document.getElementById('modalCancel')?.addEventListener('click', () => {
                    this.hideModal();
                });

                // 快速操作按鈕
                document.getElementById('emergencyDispatch')?.addEventListener('click', () => {
                    this.handleEmergencyDispatch();
                });

                document.getElementById('rerouteAll')?.addEventListener('click', () => {
                    this.handleRerouteAll();
                });

                document.getElementById('realTimeReroute')?.addEventListener('click', () => {
                    this.handleRealTimeReroute();
                });
            }

            // 檢查登入狀態
            checkLoginStatus() {
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    this.showMainSystem();
                } else {
                    this.showLoginPage();
                }
            }

            // 處理登入
            async handleLogin() {
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value.trim();
                const loginBtn = document.getElementById('loginBtn');
                const loginError = document.getElementById('loginError');

                if (!username || !password) {
                    this.showLoginError('請輸入帳號和密碼');
                    return;
                }

                // 顯示載入狀態
                loginBtn.disabled = true;
                loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 登入中...';
                loginError.textContent = '';

                try {
                    // 驗證使用者
                    const user = await this.authenticateUser(username, password);
                    
                    if (user) {
                        // 登入成功
                        currentUser = user;
                        localStorage.setItem('currentUser', JSON.stringify(user));
                        this.showMainSystem();
                        this.showNotification('登入成功', 'success');
                    } else {
                        this.showLoginError('帳號或密碼錯誤');
                    }
                } catch (error) {
                    console.error('登入錯誤:', error);
                    this.showLoginError('登入失敗，請稍後再試');
                } finally {
                    // 恢復按鈕狀態
                    loginBtn.disabled = false;
                    loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> 登入';
                }
            }

            // 使用者驗證
            async authenticateUser(username, password) {
                try {
                    const response = await fetch(CONFIG.GAS_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'text/plain',
                        },
                        body: JSON.stringify({
                            action: 'authenticateUser',
                            data: { username, password }
                        }),
                        mode: 'cors',
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        return {
                            username: result.data.username,
                            name: result.data.name || username,
                            role: result.data.role || 's1',
                            level: PERMISSIONS[result.data.role]?.name || '初階使用者',
                            permissions: PERMISSIONS[result.data.role]?.pages || ['dashboard'],
                            lastLogin: new Date().toISOString()
                        };
                    }
                    
                    return null;
                } catch (error) {
                    console.error('驗證請求失敗:', error);
                    // 開發階段的備用驗證
                    if (CONFIG.USE_MOCK_DATA) {
                        return this.mockAuthenticate(username, password);
                    }
                    throw error;
                }
            }

            // 模擬驗證（開發用）
            mockAuthenticate(username, password) {
                const mockUsers = {
                    'admin': { role: 's4', name: '系統管理員' },
                    'manager': { role: 's3', name: '主要執行者' },
                    'operator': { role: 's2', name: '次要執行者' },
                    'user': { role: 's1', name: '初階使用者' }
                };

                if (mockUsers[username] && password === '123456') {
                    const user = mockUsers[username];
                    return {
                        username: username,
                        name: user.name,
                        role: user.role,
                        level: PERMISSIONS[user.role]?.name || '初階使用者',
                        permissions: PERMISSIONS[user.role]?.pages || ['dashboard'],
                        lastLogin: new Date().toISOString()
                    };
                }
                return null;
            }

            // 顯示登入錯誤
            showLoginError(message) {
                const loginError = document.getElementById('loginError');
                if (loginError) {
                    loginError.textContent = message;
                    loginError.style.color = '#ef4444';
                    loginError.style.marginTop = '1rem';
                    loginError.style.textAlign = 'center';
                }
            }

            // 處理登出
            handleLogout() {
                localStorage.removeItem('currentUser');
                currentUser = { username: '', name: '', role: '', level: '', permissions: [], lastLogin: null };
                this.showLoginPage();
                this.showNotification('已登出', 'info');
            }

            // 顯示登入頁面
            showLoginPage() {
                document.getElementById('loginContainer').style.display = 'flex';
                document.getElementById('mainSystem').classList.remove('show');
                
                // 清空登入表單
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('loginError').textContent = '';
            }

            // 顯示主系統
            showMainSystem() {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainSystem').classList.add('show');
                
                // 更新使用者資訊顯示
                document.getElementById('currentUserName').textContent = currentUser.name || currentUser.username;
                document.getElementById('currentUserRole').textContent = currentUser.level;
                
                // 初始化權限檢查
                this.initPermissions();
            }

            // 初始化權限檢查
            initPermissions() {
                const menuItems = document.querySelectorAll('.menu-item');
                
                menuItems.forEach(item => {
                    const permission = item.dataset.permission;
                    if (permission && !currentUser.permissions.includes(permission)) {
                        item.style.display = 'none';
                    } else {
                        item.style.display = 'flex';
                    }
                });
            }

            // 頁面導航
            navigateToPage(pageId, permission) {
                // 檢查權限
                if (permission && !currentUser.permissions.includes(permission)) {
                    this.showNotification('您沒有權限存取此頁面', 'warning');
                    return;
                }

                // 隱藏所有頁面
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });

                // 移除所有選單項目的 active 狀態
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                });

                // 顯示目標頁面
                const targetPage = document.getElementById(pageId);
                if (targetPage) {
                    targetPage.classList.add('active');
                }

                // 設定選單項目為 active
                const targetMenuItem = document.querySelector(`[data-page="${pageId}"]`);
                if (targetMenuItem) {
                    targetMenuItem.classList.add('active');
                }

                // 特殊頁面處理
                this.handleSpecialPageLogic(pageId);
            }

            // 特殊頁面邏輯處理
            handleSpecialPageLogic(pageId) {
                switch (pageId) {
                    case 'system-settings':
                        this.checkSettingsAccess();
                        break;
                    case 'reports':
                        this.checkReportsAccess();
                        break;
                    case 'route-optimization':
                        this.initOptimizationPage();
                        break;
                }
            }

            // 檢查設定頁面存取權限
            checkSettingsAccess() {
                const accessDenied = document.getElementById('accessDenied');
                const settingsContent = document.getElementById('settingsContent');
                
                if (currentUser.role !== 's4') {
                    accessDenied.style.display = 'block';
                    settingsContent.style.display = 'none';
                } else {
                    accessDenied.style.display = 'none';
                    settingsContent.style.display = 'block';
                }
            }

            // 檢查報表頁面存取權限
            checkReportsAccess() {
                const reportsAccessDenied = document.getElementById('reportsAccessDenied');
                const reportsContent = document.getElementById('reportsContent');
                
                if (!['s3', 's4'].includes(currentUser.role)) {
                    reportsAccessDenied.style.display = 'block';
                    reportsContent.style.display = 'none';
                } else {
                    reportsAccessDenied.style.display = 'none';
                    reportsContent.style.display = 'block';
                }
            }

            // 初始化優化頁面
            initOptimizationPage() {
                // 設定預設時間窗口
                const startTime = document.getElementById('startTime');
                const endTime = document.getElementById('endTime');
                
                if (startTime && !startTime.value) {
                    startTime.value = '08:00';
                }
                if (endTime && !endTime.value) {
                    endTime.value = '18:00';
                }
            }

            // 獲取派車收送點清單
            async fetchDeliveryPoints() {
                const dateInput = document.getElementById('deliveryDatePicker').value;
                if (!dateInput) {
                    this.showNotification('請選擇日期', 'warning');
                    return;
                }
                
                const date = this.formatDateForSheet(dateInput);
                
                this.showLoading();
                try {
                    // 步驟1: 寫入指定日期到外部Google Sheet
                    await this.writeSpecifiedDateToExternalSheet(date);
                    
                    // 步驟2: 啟動外部APPS SCRIPT的autoCompleteProcess函數
                    await this.triggerAutoCompleteProcess();
                    
                    // 步驟3: 獲取託收託運回報_篩選工作表的資料
                    const data = await this.getFilteredDeliveryData();
                    
                    // 步驟4: 顯示資料
                    this.renderDeliveryPointsTable(data);
                    this.showNotification(`載入 ${data.length} 筆收送點資料`, 'success');
                    
                } catch (e) {
                    console.error('資料載入失敗:', e);
                    this.showNotification(`資料載入失敗: ${e.message}`, 'error');
                } finally {
                    this.hideLoading();
                }
            }

            // 寫入指定日期到外部Google Sheet
            async writeSpecifiedDateToExternalSheet(date) {
                try {
                    const response = await fetch(CONFIG.EXTERNAL_GAS_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'text/plain',
                        },
                        body: JSON.stringify({
                            action: 'writeSpecifiedDate',
                            data: { date: date }
                        }),
                        mode: 'cors',
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (!result.success) {
                        throw new Error(result.error || '寫入指定日期失敗');
                    }

                    console.log('指定日期寫入成功:', result);
                    return result.data;
                    
                } catch (error) {
                    console.error('寫入指定日期失敗:', error);
                    throw new Error(`寫入指定日期失敗: ${error.message}`);
                }
            }

            // 啟動外部APPS SCRIPT的autoCompleteProcess函數
            async triggerAutoCompleteProcess() {
                try {
                    const response = await fetch(CONFIG.EXTERNAL_GAS_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'text/plain',
                        },
                        body: JSON.stringify({
                            action: 'autoCompleteProcess',
                            data: {}
                        }),
                        mode: 'cors',
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (!result.success) {
                        throw new Error(result.error || '啟動自動完成處理失敗');
                    }

                    console.log('自動完成處理啟動成功:', result);
                    return result.data;
                    
                } catch (error) {
                    console.error('啟動自動完成處理失敗:', error);
                    throw new Error(`啟動自動完成處理失敗: ${error.message}`);
                }
            }

            // 獲取託收託運回報_篩選工作表的資料
            async getFilteredDeliveryData() {
                try {
                    const response = await fetch(CONFIG.EXTERNAL_GAS_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'text/plain',
                        },
                        body: JSON.stringify({
                            action: 'getFilteredDeliveryData',
                            data: {}
                        }),
                        mode: 'cors',
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (!result.success) {
                        throw new Error(result.error || '獲取篩選資料失敗');
                    }

                    console.log('篩選資料獲取成功:', result);
                    return result.data || [];
                    
                } catch (error) {
                    console.error('獲取篩選資料失敗:', error);
                    throw new Error(`獲取篩選資料失敗: ${error.message}`);
                }
            }

            // AI預排處理
            async handleAIPreplan() {
                const deliveryList = this.getDeliveryListFromTable();
                if (!deliveryList.length) {
                    this.showNotification('請先查詢並顯示收送點清單', 'warning');
                    return;
                }

                // 顯示 loading
                const resultDiv = document.getElementById('gai-route-result');
                resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在載入明日建議派車表...';

                try {
                    // 呼叫外部APPS SCRIPT獲取明日建議派車表
                    const result = await this.getTomorrowDispatchTableFromExternal();
                    
                    if (result && result.length > 0) {
                        // 將資料轉換為表格格式並顯示
                        const tableHtml = this.convertToDispatchTable(result);
                        resultDiv.innerHTML = `
                            <div style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; background: #f8f9fa; margin-top: 1rem;">
                                <h4 style="margin-bottom: 1rem; color: #2563eb;">
                                    <i class="fas fa-calendar-day"></i> 明日建議派車表
                                </h4>
                                <div style="font-size: 0.875rem; color: #64748b; margin-bottom: 1rem;">
                                    資料更新時間: ${new Date().toLocaleString('zh-TW')}
                                </div>
                                <div class="markdown-content" style="overflow-x: auto;">
                                    ${tableHtml}
                                </div>
                                <div style="margin-top: 1rem; text-align: right;">
                                    <button class="btn btn-primary btn-sm" onclick="app.exportDispatchTable()">
                                        <i class="fas fa-download"></i> 匯出表格
                                    </button>
                                    <button class="btn btn-secondary btn-sm" onclick="app.refreshDispatchTable()" style="margin-left: 0.5rem;">
                                        <i class="fas fa-sync-alt"></i> 重新整理
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        this.showNotification('明日建議派車表載入完成', 'success');
                    } else {
                        throw new Error('無法取得派車表資料');
                    }
                } catch (e) {
                    console.error('載入派車表失敗:', e);
                    resultDiv.innerHTML = `
                        <div style="color: #dc2626; padding: 1rem; border: 1px solid #fecaca; border-radius: 4px; background: #fef2f2;">
                            <i class="fas fa-exclamation-triangle"></i> 載入失敗: ${e.message}
                            <br><small>請檢查網路連線或聯絡系統管理員</small>
                        </div>
                    `;
                }
            }

            // 從外部APPS SCRIPT獲取明日建議派車表
            async getTomorrowDispatchTableFromExternal() {
                try {
                    const response = await fetch(CONFIG.EXTERNAL_GAS_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'text/plain',
                        },
                        body: JSON.stringify({
                            action: 'getTomorrowDispatchTable',
                            data: {}
                        }),
                        mode: 'cors',
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (!result.success) {
                        throw new Error(result.error || '獲取派車表失敗');
                    }

                    return result.data || [];
                    
                } catch (error) {
                    console.error('獲取派車表失敗:', error);
                    throw new Error(`獲取派車表失敗: ${error.message}`);
                }
            }

            // 工具方法
            formatDateForSheet(dateStr) {
                if (!dateStr) return '';
                return dateStr.replace(/-/g, '/');
            }

            getDeliveryListFromTable() {
                const table = document.querySelector('#deliveryPointsTableContainer table');
                if (!table) return [];
                
                const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
                const rows = Array.from(table.querySelectorAll('tbody tr'));
                
                return rows.map(tr => {
                    const cells = Array.from(tr.querySelectorAll('td'));
                    const obj = {};
                    headers.forEach((h, i) => obj[h] = cells[i]?.textContent.trim() || '');
                    return obj;
                });
            }

            renderDeliveryPointsTable(data) {
                const container = document.getElementById('deliveryPointsTableContainer');
                container.innerHTML = '';
                
                if (!data || data.length === 0) {

                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #64748b;">查無資料</div>';
                    return;
                }
                
                const headers = Object.keys(data[0]);
                
                const tableHtml = `
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                        <thead>
                            <tr style="background: #f1f5f9;">
                                ${headers.map(h => `<th style="padding: 0.75rem; border: 1px solid #e2e8f0; text-align: left; font-weight: 600;">${h}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(row => `
                                <tr style="border-bottom: 1px solid #e2e8f0;">
                                    ${headers.map(h => `<td style="padding: 0.75rem; border: 1px solid #e2e8f0;">${row[h] || ''}</td>`).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                container.innerHTML = tableHtml;
            }

            convertToDispatchTable(data) {
                if (!data || data.length === 0) {
                    return '<div style="text-align: center; padding: 2rem; color: #64748b;">查無派車資料</div>';
                }
                
                const headers = Object.keys(data[0]);
                
                return `
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem; background: white;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #0ea5e9 0%, #14b8a6 100%); color: white;">
                                ${headers.map(h => `<th style="padding: 1rem; border: 1px solid rgba(255, 255, 255, 0.2); text-align: left; font-weight: 600;">${h}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map((row, index) => `
                                <tr style="background: ${index % 2 === 0 ? '#f8fafc' : 'white'}; transition: background-color 0.2s;">
                                    ${headers.map(h => `<td style="padding: 0.75rem; border: 1px solid #e2e8f0;">${row[h] || ''}</td>`).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }

            // 匯出派車表
            exportDispatchTable() {
                const table = document.querySelector('#gai-route-result table');
                if (!table) {
                    this.showNotification('無可匯出的表格資料', 'warning');
                    return;
                }
                
                // 創建 CSV 內容
                const rows = Array.from(table.querySelectorAll('tr'));
                const csvContent = rows.map(row => {
                    const cells = Array.from(row.querySelectorAll('th, td'));
                    return cells.map(cell => `"${cell.textContent.trim()}"`).join(',');
                }).join('\n');
                
                // 下載檔案
                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `明日建議派車表_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.showNotification('派車表已匯出', 'success');
            }

            // 重新整理派車表
            async refreshDispatchTable() {
                await this.handleAIPreplan();
            }

            // 載入天氣資料
            async loadWeatherData() {
                try {
                    const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=Taipei,TW&appid=${CONFIG.WEATHER_API_KEY}&units=metric&lang=zh_tw`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.updateWeatherDisplay(data);
                        this.currentWeather = data;
                    } else {
                        this.showMockWeather();
                    }
                } catch (error) {
                    console.error('載入天氣資料失敗:', error);
                    this.showMockWeather();
                }
            }

            // 更新天氣顯示
            updateWeatherDisplay(data) {
                document.getElementById('weatherTemp').textContent = `${Math.round(data.main.temp)}°C`;
                document.getElementById('weatherDescription').textContent = data.weather[0].description;
                document.getElementById('weatherVisibility').textContent = `${(data.visibility / 1000).toFixed(1)} km`;
                document.getElementById('weatherWind').textContent = `${data.wind.speed} m/s`;
                document.getElementById('weatherHumidity').textContent = `${data.main.humidity}%`;
                document.getElementById('weatherFeelsLike').textContent = `${Math.round(data.main.feels_like)}°C`;
                
                // 更新天氣圖示
                const iconMap = {
                    '01d': 'fas fa-sun',
                    '01n': 'fas fa-moon',
                    '02d': 'fas fa-cloud-sun',
                    '02n': 'fas fa-cloud-moon',
                    '03d': 'fas fa-cloud',
                    '03n': 'fas fa-cloud',
                    '04d': 'fas fa-clouds',
                    '04n': 'fas fa-clouds',
                    '09d': 'fas fa-cloud-rain',
                    '09n': 'fas fa-cloud-rain',
                    '10d': 'fas fa-cloud-sun-rain',
                    '10n': 'fas fa-cloud-moon-rain',
                    '11d': 'fas fa-bolt',
                    '11n': 'fas fa-bolt',
                    '13d': 'fas fa-snowflake',
                    '13n': 'fas fa-snowflake',
                    '50d': 'fas fa-smog',
                    '50n': 'fas fa-smog'
                };
                
                const iconClass = iconMap[data.weather[0].icon] || 'fas fa-cloud';
                document.getElementById('weatherIcon').innerHTML = `<i class="${iconClass}"></i>`;
            }

            // 顯示模擬天氣資料
            showMockWeather() {
                document.getElementById('weatherTemp').textContent = '25°C';
                document.getElementById('weatherDescription').textContent = '多雲';
                document.getElementById('weatherVisibility').textContent = '10.0 km';
                document.getElementById('weatherWind').textContent = '3.2 m/s';
                document.getElementById('weatherHumidity').textContent = '65%';
                document.getElementById('weatherFeelsLike').textContent = '27°C';
                document.getElementById('weatherIcon').innerHTML = '<i class="fas fa-cloud"></i>';
            }

            // 載入儀表板資料
            async loadDashboardData() {
                try {
                    if (CONFIG.USE_MOCK_DATA) {
                        this.updateDashboardDisplay(this.getMockDashboardData());
                        return;
                    }

                    const response = await fetch(CONFIG.GAS_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'text/plain',
                        },
                        body: JSON.stringify({
                            action: 'getDashboardData',
                            data: {}
                        }),
                        mode: 'cors',
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            this.updateDashboardDisplay(result.data);
                        } else {
                            this.updateDashboardDisplay(this.getMockDashboardData());
                        }
                    } else {
                        this.updateDashboardDisplay(this.getMockDashboardData());
                    }
                } catch (error) {
                    console.error('載入儀表板資料失敗:', error);
                    this.updateDashboardDisplay(this.getMockDashboardData());
                }
            }

            // 獲取模擬儀表板資料
            getMockDashboardData() {
                return {
                    todayDeliveries: Math.floor(Math.random() * 50) + 20,
                    vehicleUsage: Math.floor(Math.random() * 30) + 70,
                    onTimeRate: Math.floor(Math.random() * 10) + 90,
                    alertCount: Math.floor(Math.random() * 5)
                };
            }

            // 更新儀表板顯示
            updateDashboardDisplay(data) {
                document.getElementById('todayDeliveries').textContent = data.todayDeliveries || 0;
                document.getElementById('vehicleUsage').textContent = `${data.vehicleUsage || 0}%`;
                document.getElementById('onTimeRate').textContent = `${data.onTimeRate || 0}%`;
                document.getElementById('alertCount').textContent = data.alertCount || 0;
                
                this.dashboardData = data;
            }

            // 重新整理儀表板
            async refreshDashboard() {
                this.showLoading();
                try {
                    await Promise.all([
                        this.loadWeatherData(),
                        this.loadDashboardData()
                    ]);
                    this.showNotification('儀表板已更新', 'success');
                } catch (error) {
                    console.error('重新整理失敗:', error);
                    this.showNotification('重新整理失敗', 'error');
                } finally {
                    this.hideLoading();
                }
            }

            // 切換地圖檢視
            async toggleMapView() {
                const mapsDashboard = document.getElementById('mapsDashboard');
                const dashboardStats = document.getElementById('dashboardStats');
                const toggleBtn = document.getElementById('toggleMapView');
                
                if (mapsDashboard.style.display === 'none' || !mapsDashboard.style.display) {
                    // 顯示地圖
                    mapsDashboard.style.display = 'grid';
                    dashboardStats.style.display = 'none';
                    toggleBtn.innerHTML = '<i class="fas fa-chart-bar"></i> 統計模式';
                    
                    // 初始化 Google Maps
                    if (!mapsApiLoaded) {
                        try {
                            await loadGoogleMapsAPI();
                        } catch (error) {
                            console.error('載入 Google Maps API 失敗:', error);
                            this.showNotification('地圖載入失敗', 'error');
                            return;
                        }
                    }
                    
                    if (!this.mapsIntegration.isInitialized) {
                        const success = await this.mapsIntegration.initializeMap('googleMap');
                        if (!success) {
                            this.showNotification('地圖初始化失敗', 'error');
                            return;
                        }
                    }
                } else {
                    // 顯示統計
                    mapsDashboard.style.display = 'none';
                    dashboardStats.style.display = 'grid';
                    toggleBtn.innerHTML = '<i class="fas fa-map"></i> 地圖模式';
                }
            }

            // 切換路線地圖檢視
            async toggleRouteMapView() {
                const routeMapsDashboard = document.getElementById('routeMapsDashboard');
                const routeTableContainer = document.getElementById('routeTableContainer');
                const toggleBtn = document.getElementById('toggleRouteMapView');
                
                if (routeMapsDashboard.style.display === 'none' || !routeMapsDashboard.style.display) {
                    // 顯示地圖
                    routeMapsDashboard.style.display = 'grid';
                    routeTableContainer.style.display = 'none';
                    toggleBtn.innerHTML = '<i class="fas fa-table"></i> 表格模式';
                    
                    // 初始化路線地圖
                    if (!mapsApiLoaded) {
                        try {
                            await loadGoogleMapsAPI();
                        } catch (error) {
                            console.error('載入 Google Maps API 失敗:', error);
                            this.showNotification('地圖載入失敗', 'error');
                            return;
                        }
                    }
                    
                    // 初始化路線地圖
                    await this.initializeRouteMap();
                } else {
                    // 顯示表格
                    routeMapsDashboard.style.display = 'none';
                    routeTableContainer.style.display = 'block';
                    toggleBtn.innerHTML = '<i class="fas fa-map"></i> 地圖模式';
                }
            }

            // 初始化路線地圖
            async initializeRouteMap() {
                const success = await this.mapsIntegration.initializeMap('routeGoogleMap');
                if (success) {
                    // 載入路線資料到地圖
                    this.loadRoutesToMap();
                }
            }

            // 載入路線到地圖
            loadRoutesToMap() {
                // 這裡可以載入實際的路線資料
                console.log('載入路線到地圖');
            }

            // 處理地點搜尋
            handlePlacesSearch(query) {
                if (query.length < 2) {
                    document.getElementById('placesSuggestions').style.display = 'none';
                    return;
                }

                this.mapsIntegration.searchPlaces(query, (predictions) => {
                    this.displayPlacesSuggestions(predictions);
                });
            }

            // 顯示地點建議
            displayPlacesSuggestions(predictions) {
                const suggestionsContainer = document.getElementById('placesSuggestions');
                
                if (predictions.length === 0) {
                    suggestionsContainer.style.display = 'none';
                    return;
                }

                const suggestionsHtml = predictions.map(prediction => 
                    `<div class="suggestion-item" data-place-id="${prediction.place_id}">
                        <div class="suggestion-main">${prediction.structured_formatting.main_text}</div>
                        <div class="suggestion-secondary">${prediction.structured_formatting.secondary_text}</div>
                    </div>`
                ).join('');

                suggestionsContainer.innerHTML = suggestionsHtml;
                suggestionsContainer.style.display = 'block';

                // 新增點擊事件
                suggestionsContainer.querySelectorAll('.suggestion-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const placeId = e.currentTarget.dataset.placeId;
                        this.selectPlace(placeId);
                    });
                });
            }

            // 選擇地點
            selectPlace(placeId) {
                // 使用 Places API 獲取詳細資訊
                const request = {
                    placeId: placeId,
                    fields: ['name', 'geometry', 'formatted_address']
                };

                this.mapsIntegration.placesService.getDetails(request, (place, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK) {
                        // 在地圖上標記
                        this.mapsIntegration.addMarker(
                            place.geometry.location,
                            place.name
                        );
                        
                        // 移動地圖視角
                        this.mapsIntegration.map.setCenter(place.geometry.location);
                        this.mapsIntegration.map.setZoom(15);
                        
                        // 更新搜尋框
                        document.getElementById('placesSearch').value = place.name;
                        document.getElementById('placesSuggestions').style.display = 'none';
                    }
                });
            }

            // 新增途經點
            addWaypoint() {
                const waypointsList = document.getElementById('waypointsList');
                const waypointCount = waypointsList.querySelectorAll('.waypoint-input').length;
                
                if (waypointCount >= 8) {
                    this.showNotification('最多只能新增8個途經點', 'warning');
                    return;
                }

                const waypointHtml = `
                    <div class="waypoint-input">
                        <i class="fas fa-circle" style="color: orange;"></i>
                        <input type="text" placeholder="途經點 ${waypointCount - 1}" class="form-input waypoint-address" data-type="waypoint">
                        <button type="button" class="btn btn-sm btn-danger remove-waypoint">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;

                // 在終點前插入
                const destinationInput = waypointsList.querySelector('[data-type="destination"]').parentElement;
                destinationInput.insertAdjacentHTML('beforebegin', waypointHtml);

                // 新增移除按鈕事件
                const newWaypoint = destinationInput.previousElementSibling;
                newWaypoint.querySelector('.remove-waypoint').addEventListener('click', () => {
                    newWaypoint.remove();
                });
            }

            // 計算路線
            async calculateRoute() {
                const waypointInputs = document.querySelectorAll('.waypoint-address');
                const addresses = Array.from(waypointInputs).map(input => input.value.trim()).filter(addr => addr);

                if (addresses.length < 2) {
                    this.showNotification('請至少輸入起點和終點', 'warning');
                    return;
                }

                try {
                    this.showLoading();
                    
                    // 地理編碼所有地址
                    const locations = [];
                    for (const address of addresses) {
                        try {
                            const result = await this.mapsIntegration.geocodeAddress(address);
                            locations.push(result.location);
                        } catch (error) {
                            throw new Error(`無法找到地址: ${address}`);
                        }
                    }

                    // 計算路線
                    const routeInfo = await this.mapsIntegration.calculateRoute(locations, false);
                    
                    // 更新路線資訊顯示
                    document.getElementById('routeDistance').textContent = routeInfo.distance;
                    document.getElementById('routeDuration').textContent = routeInfo.duration;
                    document.getElementById('routeInfo').style.display = 'block';
                    
                    this.showNotification('路線計算完成', 'success');
                    
                } catch (error) {
                    console.error('路線計算失敗:', error);
                    this.showNotification(error.message, 'error');
                } finally {
                    this.hideLoading();
                }
            }

            // 儲存路線
            saveRoute() {
                if (!this.mapsIntegration.currentRoute) {
                    this.showNotification('請先計算路線', 'warning');
                    return;
                }

                // 這裡可以實作儲存路線的邏輯
                this.showNotification('路線已儲存', 'success');
            }

            // 計算距離矩陣
            async calculateDistanceMatrix() {
                const waypointInputs = document.querySelectorAll('.waypoint-address');
                const addresses = Array.from(waypointInputs).map(input => input.value.trim()).filter(addr => addr);

                if (addresses.length < 2) {
                    this.showNotification('請至少輸入2個地點', 'warning');
                    return;
                }

                try {
                    this.showLoading();
                    
                    const matrix = await this.mapsIntegration.calculateDistanceMatrix(addresses, addresses);
                    this.displayDistanceMatrix(matrix, addresses);
                    
                    this.showNotification('距離矩陣計算完成', 'success');
                    
                } catch (error) {
                    console.error('距離矩陣計算失敗:', error);
                    this.showNotification('距離矩陣計算失敗', 'error');
                } finally {
                    this.hideLoading();
                }
            }

            // 顯示距離矩陣
            displayDistanceMatrix(matrix, addresses) {
                const container = document.getElementById('distanceMatrix');
                
                let html = '<table class="matrix-table">';
                html += '<tr><th></th>';
                
                // 標題行
                addresses.forEach(addr => {
                    html += `<th>${addr.substring(0, 10)}...</th>`;
                });
                html += '</tr>';

                // 資料行
                matrix.rows.forEach((row, i) => {
                    html += `<tr><th>${addresses[i].substring(0, 10)}...</th>`;
                    row.elements.forEach(element => {
                        if (element.status === 'OK') {
                            html += `<td>${element.distance.text}<br><small>${element.duration.text}</small></td>`;
                        } else {
                            html += '<td>-</td>';
                        }
                    });
                    html += '</tr>';
                });

                html += '</table>';
                container.innerHTML = html;
            }

            // 優化路線
            async optimizeRoute() {
                const waypointInputs = document.querySelectorAll('.waypoint-address');
                const addresses = Array.from(waypointInputs).map(input => input.value.trim()).filter(addr => addr);

                if (addresses.length < 3) {
                    this.showNotification('優化功能需要至少3個地點', 'warning');
                    return;
                }

                try {
                    this.showLoading();
                    
                    // 地理編碼所有地址
                    const locations = [];
                    for (const address of addresses) {
                        const result = await this.mapsIntegration.geocodeAddress(address);
                        locations.push(result.location);
                    }

                    // 計算優化路線
                    const optimizedRoute = await this.mapsIntegration.calculateRoute(locations, true);
                    
                    // 顯示優化結果
                    this.displayOptimizationResults(optimizedRoute);
                    
                    this.showNotification('路線優化完成', 'success');
                    
                } catch (error) {
                    console.error('路線優化失敗:', error);
                    this.showNotification('路線優化失敗', 'error');
                } finally {
                    this.hideLoading();
                }
            }

            // 顯示優化結果
            displayOptimizationResults(optimizedRoute) {
                const resultsContainer = document.getElementById('optimizationResults');
                
                // 假設原始路線資訊
                const originalDistance = '50.2 km';
                const originalTime = '85 分鐘';
                
                document.getElementById('savedDistance').textContent = '8.5 km (17%)';
                document.getElementById('savedTime').textContent = '12 分鐘 (14%)';
                
                resultsContainer.style.display = 'block';
            }

            // 切換側邊標籤
            switchSidebarTab(tabId) {
                // 移除所有標籤的 active 狀態
                document.querySelectorAll('.sidebar-tab').forEach(tab => {
                    tab.classList.remove('active');
                });

                // 隱藏所有標籤內容
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.style.display = 'none';
                });

                // 啟用目標標籤
                document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
                document.getElementById(`${tabId}-tab`).style.display = 'block';
            }

            // 開始優化分析
            startOptimizationAnalysis() {
                const target = document.querySelector('input[name="optimizeTarget"]:checked').value;
                const vehicleLimit = document.getElementById('vehicleLimit').value;
                const startTime = document.getElementById('startTime').value;
                const endTime = document.getElementById('endTime').value;

                // 顯示進度條
                const progressContainer = document.getElementById('optimizationProgress');
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');
                const resultsContainer = document.getElementById('optimizationResults');

                progressContainer.style.display = 'block';
                resultsContainer.style.display = 'none';

                // 模擬優化過程
                let progress = 0;
                const interval = setInterval(() => {
                    progress += Math.random() * 15;
                    if (progress > 100) progress = 100;

                    progressFill.style.width = `${progress}%`;
                    
                    if (progress < 30) {
                        progressText.textContent = '分析路線資料...';
                    } else if (progress < 60) {
                        progressText.textContent = '計算最佳路徑...';
                    } else if (progress < 90) {
                        progressText.textContent = '優化車輛配置...';
                    } else {
                        progressText.textContent = '生成報告...';
                    }

                    if (progress >= 100) {
                        clearInterval(interval);
                        setTimeout(() => {
                            progressContainer.style.display = 'none';
                            this.showOptimizationResults();
                        }, 500);
                    }
                }, 200);
            }

            // 顯示優化結果
            showOptimizationResults() {
                const resultsContainer = document.getElementById('optimizationResults');
                
                // 模擬優化結果
                document.getElementById('beforeDistance').textContent = '285.6 km';
                document.getElementById('afterDistance').textContent = '247.3 km';
                document.getElementById('savedDistance').textContent = '38.3 km (13.4%)';
                
                resultsContainer.style.display = 'block';
                this.showNotification('優化分析完成', 'success');
            }

            // 緊急調派處理
            handleEmergencyDispatch() {
                this.showModal(
                    '緊急調派',
                    '<p>是否確認啟動緊急調派程序？</p><p class="text-warning">此操作將重新分配所有可用車輛。</p>',
                    () => {
                        this.showNotification('緊急調派已啟動', 'warning');
                        this.hideModal();
                    }
                );
            }

            // 路線重規劃處理
            handleRerouteAll() {
                this.showModal(
                    '路線重規劃',
                    '<p>是否確認重新規劃所有路線？</p><p class="text-info">此操作可能需要5-10分鐘完成。</p>',
                    () => {
                        this.showNotification('路線重規劃已開始', 'info');
                        this.hideModal();
                    }
                );
            }

            // 即時改道處理
            handleRealTimeReroute() {
                this.showNotification('即時改道功能開發中', 'info');
            }

            // 顯示模態視窗
            showModal(title, content, confirmCallback = null) {
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalBody').innerHTML = content;
                document.getElementById('modal').classList.add('show');

                // 設定確認按鈕事件
                const confirmBtn = document.getElementById('modalConfirm');
                confirmBtn.onclick = confirmCallback || (() => this.hideModal());
            }

            // 隱藏模態視窗
            hideModal() {
                document.getElementById('modal').classList.remove('show');
            }

            // 顯示載入中
            showLoading() {
                document.getElementById('loadingOverlay').classList.add('show');
            }

            // 隱藏載入中
            hideLoading() {
                document.getElementById('loadingOverlay').classList.remove('show');
            }

            // 顯示通知
            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <i class="fas fa-${this.getNotificationIcon(type)}"></i>
                    <span>${message}</span>
                `;

                document.body.appendChild(notification);

                // 顯示動畫
                setTimeout(() => notification.classList.add('show'), 100);

                // 自動隱藏
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }

                        // 獲取通知圖示
            getNotificationIcon(type) {
                const icons = {
                    success: 'check-circle',
                    error: 'exclamation-circle',
                    warning: 'exclamation-triangle',
                    info: 'info-circle'
                };
                return icons[type] || 'info-circle';
            }

            // 更新連線狀態
            updateConnectionStatus(status) {
                const statusElement = document.getElementById('connectionStatus');
                const statusMap = {
                    online: { class: 'online', icon: 'fas fa-wifi', text: '已連線' },
                    offline: { class: 'offline', icon: 'fas fa-wifi-slash', text: '離線' },
                    mock: { class: 'mock', icon: 'fas fa-exclamation-triangle', text: '模擬模式' }
                };

                const config = statusMap[status] || statusMap.online;
                statusElement.className = `connection-status ${config.class}`;
                statusElement.innerHTML = `<i class="${config.icon}"></i> ${config.text}`;
            }
        }

        // 初始化應用程式
        const app = new DispatchGAISystem();

        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM 載入完成，開始初始化系統...');
            
            // 設定連線狀態
            app.updateConnectionStatus(CONFIG.USE_MOCK_DATA ? 'mock' : 'online');
            
            // 初始化系統
            await app.init();
            
            // 監聽網路狀態變化
            window.addEventListener('online', () => {
                app.updateConnectionStatus('online');
                app.showNotification('網路連線已恢復', 'success');
            });
            
            window.addEventListener('offline', () => {
                app.updateConnectionStatus('offline');
                app.showNotification('網路連線中斷', 'warning');
            });
            
            console.log('系統初始化完成');
        });

        // 全域錯誤處理
        window.addEventListener('error', (event) => {
            console.error('全域錯誤:', event.error);
            app.showNotification('系統發生錯誤，請重新整理頁面', 'error');
        });

        // 全域未處理的 Promise 拒絕
        window.addEventListener('unhandledrejection', (event) => {
            console.error('未處理的 Promise 拒絕:', event.reason);
            app.showNotification('系統發生錯誤，請重新整理頁面', 'error');
        });

        // 鍵盤快捷鍵
        document.addEventListener('keydown', (event) => {
            // Ctrl+/ 顯示快捷鍵說明
            if (event.ctrlKey && event.key === '/') {
                event.preventDefault();
                app.showModal(
                    '鍵盤快捷鍵',
                    `
                    <div style="text-align: left;">
                        <p><kbd>Ctrl + /</kbd> - 顯示快捷鍵說明</p>
                        <p><kbd>Ctrl + R</kbd> - 重新整理儀表板</p>
                        <p><kbd>Ctrl + M</kbd> - 切換地圖模式</p>
                        <p><kbd>Esc</kbd> - 關閉模態視窗</p>
                    </div>
                    `
                );
            }
            
            // Ctrl+R 重新整理儀表板
            if (event.ctrlKey && event.key === 'r') {
                event.preventDefault();
                if (document.querySelector('.page.active').id === 'dashboard') {
                    app.refreshDashboard();
                }
            }
            
            // Ctrl+M 切換地圖模式
            if (event.ctrlKey && event.key === 'm') {
                event.preventDefault();
                if (document.querySelector('.page.active').id === 'dashboard') {
                    app.toggleMapView();
                }
            }
            
            // Esc 關閉模態視窗
            if (event.key === 'Escape') {
                app.hideModal();
            }
        });

        // 防止右鍵選單（可選）
        // document.addEventListener('contextmenu', (event) => {
        //     event.preventDefault();
        // });

        // 防止選取文字（可選）
        // document.addEventListener('selectstart', (event) => {
        //     if (event.target.tagName !== 'INPUT' && event.target.tagName !== 'TEXTAREA') {
        //         event.preventDefault();
        //     }
        // });

        // 自動儲存使用者設定
        setInterval(() => {
            if (currentUser.username) {
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            }
        }, 30000); // 每30秒儲存一次

        // CSS 樣式補充
        const additionalStyles = `
            <style>
                /* 地點搜尋建議樣式 */
                .places-suggestions {
                    position: absolute;
                    top: 100%;
                    left: 0;
                    right: 0;
                    background: white;
                    border: 1px solid var(--gray-200);
                    border-radius: 8px;
                    box-shadow: var(--shadow-lg);
                    z-index: 1000;
                    max-height: 300px;
                    overflow-y: auto;
                }

                .suggestion-item {
                    padding: 0.75rem;
                    cursor: pointer;
                    border-bottom: 1px solid var(--gray-100);
                    transition: background-color 0.2s ease;
                }

                .suggestion-item:hover {
                    background: var(--gray-50);
                }

                .suggestion-item:last-child {
                    border-bottom: none;
                }

                .suggestion-main {
                    font-weight: 500;
                    color: var(--gray-800);
                }

                .suggestion-secondary {
                    font-size: 0.875rem;
                    color: var(--gray-500);
                    margin-top: 0.25rem;
                }

                /* 途經點輸入樣式 */
                .waypoint-input {
                    display: flex;
                    align-items: center;
                    gap: 0.75rem;
                    margin-bottom: 0.75rem;
                }

                .waypoint-input i {
                    font-size: 0.75rem;
                    width: 12px;
                }

                .waypoint-input .form-input {
                    flex: 1;
                    margin-bottom: 0;
                }

                .remove-waypoint {
                    min-width: auto;
                    width: 32px;
                    height: 32px;
                    padding: 0;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }

                /* 距離矩陣表格樣式 */
                .matrix-table {
                    width: 100%;
                    border-collapse: collapse;
                    font-size: 0.875rem;
                    margin-top: 1rem;
                }

                .matrix-table th,
                .matrix-table td {
                    border: 1px solid var(--gray-200);
                    padding: 0.5rem;
                    text-align: center;
                }

                .matrix-table th {
                    background: var(--gray-100);
                    font-weight: 600;
                }

                .matrix-table td small {
                    color: var(--gray-500);
                    font-size: 0.75rem;
                }

                /* 優化選項樣式 */
                .optimization-options {
                    margin: 1rem 0;
                }

                .opt-radio {
                    display: block;
                    margin-bottom: 0.5rem;
                    cursor: pointer;
                }

                .opt-radio input {
                    margin-right: 0.5rem;
                }

                /* 結果摘要樣式 */
                .result-summary {
                    background: var(--gray-50);
                    border-radius: 8px;
                    padding: 1.5rem;
                    margin-bottom: 1.5rem;
                }

                .result-item {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 0.75rem;
                }

                .result-item:last-child {
                    margin-bottom: 0;
                }

                .result-label {
                    font-weight: 500;
                    color: var(--gray-700);
                }

                .result-value {
                    font-weight: 600;
                    color: var(--gray-800);
                }

                .result-value.improvement {
                    color: var(--success-color);
                }

                /* 地圖控制按鈕樣式 */
                .map-controls {
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    z-index: 1000;
                    display: flex;
                    flex-direction: column;
                    gap: 0.5rem;
                }

                .map-control-btn {
                    width: 40px;
                    height: 40px;
                    background: white;
                    border: 1px solid var(--gray-300);
                    border-radius: 8px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    box-shadow: var(--shadow);
                    transition: all 0.2s ease;
                }

                .map-control-btn:hover {
                    background: var(--gray-50);
                    box-shadow: var(--shadow-md);
                }

                .map-control-btn.active {
                    background: var(--primary-blue);
                    color: white;
                    border-color: var(--primary-blue);
                }

                /* 地圖載入覆蓋層 */
                .map-loading-overlay {
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(255, 255, 255, 0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 999;
                }

                .map-loading-spinner {
                    width: 40px;
                    height: 40px;
                    border: 4px solid var(--gray-200);
                    border-top: 4px solid var(--primary-blue);
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                }

                /* 鍵盤快捷鍵樣式 */
                kbd {
                    background: var(--gray-100);
                    border: 1px solid var(--gray-300);
                    border-radius: 4px;
                    padding: 0.25rem 0.5rem;
                    font-family: monospace;
                    font-size: 0.875rem;
                    color: var(--gray-700);
                }

                /* 無障礙樣式 */
                .sr-only {
                    position: absolute;
                    width: 1px;
                    height: 1px;
                    padding: 0;
                    margin: -1px;
                    overflow: hidden;
                    clip: rect(0, 0, 0, 0);
                    white-space: nowrap;
                    border: 0;
                }

                /* 高對比度焦點樣式 */
                .btn:focus,
                .form-input:focus,
                .form-select:focus {
                    outline: 2px solid var(--primary-blue);
                    outline-offset: 2px;
                }

                /* 觸控裝置優化 */
                @media (hover: none) and (pointer: coarse) {
                    .btn {
                        min-height: 44px;
                        min-width: 44px;
                    }
                    
                    .map-control-btn {
                        width: 44px;
                        height: 44px;
                    }
                    
                    .menu-item {
                        min-height: 48px;
                    }
                }

                /* 列印最佳化 */
                @media print {
                    .no-print {
                        display: none !important;
                    }
                    
                    .page {
                        page-break-inside: avoid;
                    }
                    
                    .card {
                        page-break-inside: avoid;
                        margin-bottom: 1rem;
                    }
                }

                /* 深色模式準備 */
                @media (prefers-color-scheme: dark) {
                    :root {
                        --primary-blue: #3b82f6;
                        --secondary-teal: #06b6d4;
                        --accent-purple: #8b5cf6;
                        --success-color: #10b981;
                        --warning-color: #f59e0b;
                        --danger-color: #ef4444;
                        --gray-50: #1f2937;
                        --gray-100: #374151;
                        --gray-200: #4b5563;
                        --gray-300: #6b7280;
                        --gray-400: #9ca3af;
                        --gray-500: #d1d5db;
                        --gray-600: #e5e7eb;
                        --gray-700: #f3f4f6;
                        --gray-800: #f9fafb;
                        --gray-900: #ffffff;
                        --white: #111827;
                        --black: #ffffff;
                    }
                }

                /* 動畫效能優化 */
                .gpu-accelerated {
                    transform: translateZ(0);
                    will-change: transform;
                }

                /* 減少動畫偏好設定 */
                @media (prefers-reduced-motion: reduce) {
                    .notification {
                        transition: none;
                    }
                    
                    .loading-spinner i {
                        animation: none;
                    }
                    
                    .progress-fill::after {
                        animation: none;
                    }
                }
            </style>
        `;

        // 將額外樣式加入到 head
        document.head.insertAdjacentHTML('beforeend', additionalStyles);

        // PWA 支援準備
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // 可以在這裡註冊 Service Worker
                console.log('PWA 支援已準備');
            });
        }

        // 效能監控
        if ('performance' in window) {
            window.addEventListener('load', () => {
                setTimeout(() => {
                    const perfData = performance.getEntriesByType('navigation')[0];
                    console.log('頁面載入時間:', perfData.loadEventEnd - perfData.fetchStart, 'ms');
                }, 0);
            });
        }

        // 記憶體使用監控（開發用）
        if (CONFIG.USE_MOCK_DATA && 'memory' in performance) {
            setInterval(() => {
                const memory = performance.memory;
                if (memory.usedJSHeapSize > memory.jsHeapSizeLimit * 0.9) {
                    console.warn('記憶體使用量過高:', memory.usedJSHeapSize / 1024 / 1024, 'MB');
                }
            }, 30000);
        }

        console.log('昶青物流派車GAI數據管理系統載入完成');
    </script>
</body>
</html>



